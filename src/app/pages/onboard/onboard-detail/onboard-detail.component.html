<div class="content-header with-shadow">
  <div class="breadcrumb">
    <span><a [routerLink]="'/employer/onboard/list'" class="text-green">Onboard</a></span>
    <span class="fa fa-angle-right"></span>
    <span>{{ jrName }} <span *ngIf="hcId && isHybrid">({{ hcId }})</span></span>
  </div>
</div>

<nb-card>
  <nb-card-body>
    <div class="row">
      <div class="col-md-6">
        <div class="input-group">
          <input type="text" [(ngModel)]="keyword" nbInput fullWidth placeholder="Search"
            (keyup.enter)="paging.pageIndex = 0; search()">
          <div class="input-group-addon" nbTooltip="Search">
            <nb-icon icon="search-outline" class="link" (click)="paging.pageIndex = 0; search()"></nb-icon>
          </div>
        </div>
      </div>
      <!-- <div class="col-md-6" style="margin-top: 3px;">
        <nb-radio-group [(ngModel)]="collapseAll" class="inline" (valueChange)="onClickCollapseAll($event)">
          <nb-radio [value]="true">Collapse All</nb-radio>
          <nb-radio [value]="false">Expand All</nb-radio>
        </nb-radio-group>
      </div> -->
    </div>
    <div *ngIf="!isExpress || (isHybrid && jdType === 3)">
      <label class="label">Sourcing</label>
      <div class="row">
        <div class="col-md-12 inline">
          <div *ngFor="let sol of soList">
            <nb-checkbox (checkedChange)="filterSource($event,sol._id)" [(ngModel)]="sol.active">{{ sol.name }}
            </nb-checkbox>
          </div>
        </div>
      </div>
    </div>
    <div *ngIf="isExpress && questionFilter.length">
      <label class="label">Filter</label>
      <div class="row">
        <div *ngFor="let filter of questionFilter" class="col-md-6">
          <mat-form-field [color]="primary" appearance="outline" class="p-b-0">
            <mat-label>{{ filter.name }}</mat-label>
            <mat-select multiple (selectionChange)="changeQuestionFilter(filter.name, $event)"
              placeholder="{{ filter.name }}">
              <mat-option *ngFor="let value of filter.value" [value]="value">{{ value }}</mat-option>
            </mat-select>
          </mat-form-field>
        </div>
      </div>
    </div>
    <!-- filter hubs -->
    <!-- <div *ngIf="isFilter && isExpress && jdType !== 3" class="filter-block">
      <div class="row">
        <div class="col-12 col-md-4">
          <div class="form-control-group">
            <label class="label">Call type</label>
            <mat-form-field [color]="primary" appearance="outline">
              <mat-select [(ngModel)]="filterBy.filterBy" (selectionChange)="search()">
                <mat-option *ngFor="let option of callList" [value]="option.value">
                  {{option.label}}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </div>
        </div>
        <div *ngIf="filterBy.filterBy ==='called'" class="col-12 col-md-4">
          <div class="form-control-group">
            <label class="label">Called by</label>
            <mat-form-field [color]="primary" appearance="outline">
              <mat-select [(ngModel)]="userLists" (ngModelChange)="checkFiltered('called')" multiple>
                <mat-select-filter [placeholder]="'Filter'" [displayMember]="'label'" [array]="userAll"
                  (filteredReturn)="filteredUserAll =$event"></mat-select-filter>
                <mat-option *ngFor="let option of filteredUserAll" [value]="option.value">
                  {{option.label}}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </div>
        </div>
        <div *ngIf="filterBy.filterBy ==='called'" class="col-12 col-md-4">
          <div class="form-control-group">
            <label class="label">Called Date</label>
            <nb-rangepicker (rangeChange)="onEventStartEndRange($event)" #startDate></nb-rangepicker>
            <div class="input-group">
              <input nbInput fullWidth [nbDatepicker]="startDate" [(ngModel)]="startTime" style="cursor: pointer;">
              <div class="input-group-addon" style="pointer-events: none;">
                <nb-icon class="text-green" icon="calendar-outline"></nb-icon>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div><br> -->
    <!-- <div *ngIf="isFilter" class="row" style="text-align: center;">
      <div class="col-md-12">
        <button nbButton status="default" (click)="clearFilter()">
          Clear Filter
        </button>
      </div>
    </div> -->
  </nb-card-body>
</nb-card>

<nb-card>
  <nb-card-body style="padding: 0.5rem;">
    <nb-tabset fullWidth="true" (changeTab)="onSelectTab($event)">
      <nb-tab *ngFor="let tab of tabs" [tabTitle]="tab.name" [active]="tabSelected && tabSelected === tab.name"
        [badgeText]="tab.badgeText" [badgeStatus]="tab.badgeStatus" responsive="true" [tabIcon]="tab.icon"
        [nbSpinner]="loading" nbSpinnerStatus="success" nbSpinnerSize="large" nbSpinnerMessage="Loading...">
        <div *ngIf="!items.length && !loading" class="text-center text-gray">No data found !</div>
        <div *ngIf="items.length">
          <nb-card *ngFor="let item of items" accent="success">
            <nb-card-header>
              <div class="title">
                <label [ngClass]="{ 'link' : !isExpress, 'text-black' : isExpress}"
                  [nbTooltip]="utilitiesService.setFullname(item.refCandidate) || '-'"
                  (click)="openCandidateDetail(item)">
                  {{ utilitiesService.setFullname(item.refCandidate) || '-' }}
                </label>
                &nbsp;
                <span *ngIf="item.cv_id" class="label">( CV_ID : {{ item.cv_id || '' }})</span>
                &nbsp;
                <span *ngIf="isExpress && item.history && item.history.exist" class="fa fa-list-alt link"
                  (click)="openHistory(item._id)">
                </span>
                <span *ngIf="isExpress">
                  <nb-icon *ngIf="item.offer.flag && !item.offer.responsed" icon="checkmark-circle-2-outline"
                    style="margin-right: 0;color: var(--color-gray)">
                  </nb-icon>
                  <nb-icon *ngIf="item.offer.responsed && item.offer.isOk" icon="checkmark-circle-2-outline"
                    style="margin-right: 0;color: green;">
                  </nb-icon>
                  <nb-icon *ngIf="item.offer.responsed && !item.offer.isOk" icon="close-circle-outline"
                    style="margin-right: 0;color: red;"></nb-icon>
                </span>
                &nbsp;<i *ngIf="item.refCandidate.blacklist"
                  [nbTooltip]="'Blacklist - '+ item.refCandidate.blacklist.refReject.name"
                  class="fas fa-exclamation-triangle"></i>
                <small class="status">
                  <span>
                    <!-- Status: <label
                      class="label label-gray">{{ item.refStage?.name || item.refStage }}</label>&nbsp;&nbsp; -->
                    <span *ngIf="!isHybrid">HUB: </span><label *ngFor="let hub of item.hubs"
                      class="label label-info">{{ hub.refProvince.name.th }}&nbsp;
                      ({{ hub.areaName }})</label>
                  </span><br *ngIf="devices.isMobile">
                  <span *ngIf="isHybrid && jdType !== 3">Branch:
                    <label class="label" [ngClass]="utilitiesService.sourcingColors()">
                      {{ item.refJR?.refLocation?.name || '' }}</label>
                  </span>
                  <span *ngIf="isHybrid && jdType === 3">
                    <!-- <span *ngIf="!devices.isMobile">|</span> -->
                    Source:
                    <label *ngFor="let source of item.refSource" class="label"
                      [ngClass]="utilitiesService.sourcingColors(source.key)">{{ source.name || '' }}</label>
                  </span><br>
                  <small *ngIf="item.cvStatus?.cv_id">
                    <span>CV_ID: <label class="label label-info">
                        {{ item.cvStatus?.cv_id }}</label></span>
                    <br>
                  </small>
                </small>
              </div>
              <div *ngIf="isExpress" class="actions">
                <div class="link" (mouseenter)="itemSelected = item" [nbPopover]="expressScore" nbPopoverTrigger="hover"
                  nbPopoverPlacement="left">
                  <span class="fa fa-star text-orange">&nbsp;</span>
                  <span>{{ item.percentScore || 0 }}%</span>
                </div>
              </div>
            </nb-card-header>
            <nb-card-body *ngIf="!item.collapse || isHybrid">
              <div class="row">
                <div class="col-md-6 m-b-15">
                  <div class="text-group">
                    <label class="label">Age</label>
                    <span>{{ item.refCandidate?.age > 0 ? item.refCandidate?.age : '-' }}</span>
                  </div>
                  <div class="text-group">
                    <label class="label">Work Experience</label>
                    <span>{{ utilitiesService.convertMonthToYearText(item.refCandidate?.workExperience?.totalExpMonth) || '-' }}</span>
                  </div>
                  <div class="text-group">
                    <label class="label">Current Phone</label>
                    <span>{{ item.refCandidate?.phone || '-' }}</span>
                  </div>
                  <div class="text-group">
                    <label class="label">Email</label>
                    <span>{{ item.refCandidate?.email || '-' }}</span>
                  </div>
                  <div *ngIf="!isExpress || isHybrid" class="text-group">
                    <span class="link" (click)="info(item)">
                      <nb-icon icon="info-outline" class="font-inherit"></nb-icon> More Details
                    </span>
                  </div>
                  <!-- isExpress -->
                  <div *ngIf="item.hasAppform" class="text-group m-t-10 m-b-10">
                    <span class="link underline" (click)="openApplicationForm(item)">
                      <nb-icon icon="file-text-outline" class="font-inherit m-r-5"></nb-icon>
                      <span>Application Form</span>
                    </span>
                  </div>
                  <div *ngIf="isExpress" class="text-group m-t-10 m-b-10">
                    <span class="link" *ngIf="item.refCandidate?.callHistory?.length > 0"
                      (click)="openCallHistory(item)"><span>
                        <nb-icon *ngIf="item.refCandidate?.callHistory?.length > 0" class="font-inherit"
                          icon="info-outline">
                        </nb-icon>
                      </span> Call Logs </span>
                  </div>
                </div>
                <div class="col-md-6">
                  <div *ngIf="tabSelected === 'REJECTED' && item.reject.flag" class="m-t-5">
                    <label class="label text-light-gray">Reject Info</label>
                    <div class="m-l-15">
                      <div class="text-group">
                        <label class="label">Reject Reason</label>
                        <span class="text-red">{{ item.reject.rejectBy.refReject.name || '-' }}</span>
                      </div>
                      <div *ngIf="item.reject.remark" class="text-group">
                        <label class="label">Reject Remark</label>
                        <span class="text-red">{{ item.reject.remark || '-' }}</span>
                      </div>
                      <i class="text-gray">
                        <div class="text-group">
                          <label class="label">Reject By</label>
                          <span>{{ utilitiesService.setFullname(item.reject.rejectBy.refUser) || '-' }}</span>
                        </div>
                        <div class="text-group">
                          <label class="label">Reject Date</label>
                          <span>{{ utilitiesService.convertDateTime(item.reject.rejectBy.date) || '-' }}</span>
                        </div>
                      </i>
                    </div>
                  </div>
                </div>
              </div>
            </nb-card-body>
            <nb-card-footer>
              <div class="row text-left">
                <div [ngClass]="{ 'padd-1top': tabSelected === 'REJECTED' }" class="new-stepper col-12">
                  <!-- Test vertical stepper -->
                  <div *ngIf="item.onboardProcess.length > 0" style="text-align: center; font-weight: 700;">
                    <label>Onboard Process</label>
                  </div>
                  <div *ngFor="let stepItem of item.onboardProcess;let iStep = index"
                    [ngClass]="{'padd-1top' : iStep > 0}" class="row">
                    <div class="col-12">
                      <span class="open-font">Step<span class="letter"
                          style="background-color: #35c4b2;color: white;">{{ iStep + 1 }}</span>{{ stepItem.topic || '' }}
                        <span class="label">({{  utilitiesService.convertDateTime(stepItem.date) }})</span></span>
                      <small class="status">
                        <br *ngIf="stepItem.state === 1"><span *ngIf="stepItem.state === 1" class="banner-em">Job
                          Position: <label *ngIf="hcId && isHybrid" class="label-gray">{{ jrName }} ({{ hcId }})</label></span>
                        <!-- <br *ngIf="stepItem.state === 1"><span *ngIf="stepItem.state === 1" class="banner-em">HCID:
                          <label *ngIf="hcId && isHybrid" class="label label-info">{{ hcId }}</label></span> -->
                      </small>
                    </div>
                    <div class="col-3 col-sm-2 col-md-1 col-lg-1" style="padding-right: 0px;padding-left: 52px">
                      <div *ngIf="item.onboardProcess.length !== iStep + 1" class="separator">
                      </div>
                    </div>
                    <div class="col-9 col-sm-10 col-md-11 col-lg-11">
                      <div class="row">
                        <!-- [ngClass]="{ 'col-sm-6': stepItem.remark, 'col-sm-12': !stepItem.remark }" -->
                        <!-- <div class="col-12 col-sm-12">
                          <div style="word-break: break-all;">
                            <nb-user class="pad-user" size="small" [name]="stepItem.actionBy"
                              [title]="utilitiesService.convertDateTime(stepItem.date)">
                            </nb-user>
                          </div>
                        </div> -->
                        <div class="col-12 col-sm-12" style="margin-top: 0.4rem;">
                          <nb-card>
                            <nb-card-header class="border-1px">
                              <div>
                                <span class="open-font">{{ stepItem.remark || 'No comment' }}</span>
                              </div>
                              <!-- <small>{{ utilitiesService.convertDateTime(stepItem.date) }}</small> -->
                            </nb-card-header>
                          </nb-card>
                        </div>
                      </div>
                    </div>
                  </div>
                  <!-- end -->
                </div>
              </div>
            </nb-card-footer>
          </nb-card>
          <mat-paginator *ngIf="paging.length > minPageSize" [length]="paging.length" [pageIndex]="paging.pageIndex"
            [pageSize]="paging.pageSize" [pageSizeOptions]="paging.pageSizeOptions"
            (page)="pageEvent = changePaging($event)">
          </mat-paginator>
        </div>
      </nb-tab>
    </nb-tabset>
  </nb-card-body>
</nb-card>

<ng-template #expressScore>
  <div class="row" [style.max-height.px]="maxH" style="overflow: auto;">
    <div class="col-12">
      <div class="text-center m-b-10">
        <label class="label text-top text-black">Application Form Score</label>
      </div>
      <div *ngFor="let score of itemSelected.weightScoreQuestions; let i = index;" class="m-b-10 row">
        <div class="col-12">
          <div class="label m-b-5"><span>{{ score.question?.en || score.question?.th || '-' }}</span>
            <span class="pull-right">
              {{ score.submit || 0 }}/{{ score.max || 0 }}
            </span>
          </div>
        </div>
        <div class="col-12">
          <nb-progress-bar [status]="getProgressBarColor(i)" size="tiny"
            [value]="utilitiesService.calculatePercentage(score.submit,score.max)">
          </nb-progress-bar>
        </div>
      </div>
    </div>
  </div>
</ng-template>